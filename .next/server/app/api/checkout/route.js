"use strict";(()=>{var e={};e.id=607,e.ids=[607],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1568:e=>{e.exports=require("zlib")},6005:e=>{e.exports=require("node:crypto")},5730:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>k,patchFetch:()=>m,requestAsyncStorage:()=>f,routeModule:()=>d,serverHooks:()=>h,staticGenerationAsyncStorage:()=>y});var n={};r.r(n),r.d(n,{POST:()=>l});var a=r(9303),i=r(8716),c=r(670),o=r(7070),s=r(6994),u=r(214),p=r(5579);async function l(e){try{let{items:t=[],serviceItems:r=[],customer:n}=await e.json();if(0===t.length&&0===r.length)return o.NextResponse.json({error:"No hay productos ni servicios en el carrito"},{status:400});let a=await (0,u.VX)()?await (0,u.Bv)():null;if(!a)return o.NextResponse.json({error:"No hay cuenta de MercadoPago conectada. Contacta al vendedor."},{status:400});let i=new s.f7({accessToken:a}),c=function(){let e="https://karistetik.vercel.app";return e.endsWith("/")?e.slice(0,-1):e}(),l=new s.Jk(i),d=t.reduce((e,t)=>{let r=t.product?.price??t.price??0;return e+r*t.quantity},0),f=r.reduce((e,t)=>e+t.price*t.quantity,0),y=await (0,p.eA)(),h=y.enabled?Math.round(y.percentage/100*(d+f)):0,k=[...t.map(e=>({id:e.product?.id??e.id??"product",title:e.product?.name??e.name??"Producto",quantity:e.quantity,unit_price:e.product?.price??e.price??0,currency_id:"ARS",picture_url:e.product?.image??e.image})),...r.map(e=>({id:e.id,title:e.name,quantity:e.quantity,unit_price:e.price,currency_id:"ARS",picture_url:e.image}))],m=JSON.stringify({orderId:`order_${Date.now()}`,serviceItems:r.map(e=>({id:e.id,name:e.name,slots:e.selectedSlots||[]})),customer:n}),w=await l.create({body:{items:k,payer:{name:n.name,email:n.email,phone:{number:n.phone}},back_urls:{success:`${c}/success`,failure:`${c}/failure`,pending:`${c}/pending`},auto_return:"approved",statement_descriptor:"CORPEPILATES",external_reference:m,...h>0&&{marketplace_fee:h}}});return o.NextResponse.json({id:w.id,init_point:w.init_point})}catch(e){return console.error("Error creating preference:",e),o.NextResponse.json({error:"Error al crear la preferencia de pago"},{status:500})}}let d=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/checkout/route",pathname:"/api/checkout",filename:"route",bundlePath:"app/api/checkout/route"},resolvedPagePath:"C:\\Users\\agusk\\Desktop\\Stuff\\Projects\\PilatesReformer\\src\\app\\api\\checkout\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:y,serverHooks:h}=d,k="/api/checkout/route";function m(){return(0,c.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:y})}},5579:(e,t,r)=>{r.d(t,{Bu:()=>l,Wc:()=>d,_d:()=>s,eA:()=>f});var n=r(8779);let a="corpepilates:fee_enabled",i="corpepilates:fee_percentage",c="corpepilates:development_paid";async function o(){try{let e=await n.kv.get(c);return!0===e}catch{return!1}}async function s(e){try{return await n.kv.set(c,e),e&&await n.kv.set(a,!1),!0}catch{return!1}}async function u(){try{if(await o())return!1;let e=await n.kv.get(a);return!1!==e}catch{return!0}}async function p(){try{return await n.kv.get(i)??5}catch{return 5}}async function l(e){try{return await n.kv.set(a,e),!0}catch{return!1}}async function d(e){try{return await n.kv.set(i,e),!0}catch{return!1}}async function f(){let[e,t,r]=await Promise.all([u(),p(),o()]);return{enabled:e,percentage:t,developmentPaid:r}}},214:(e,t,r)=>{r.d(t,{Bv:()=>p,Db:()=>c,VX:()=>i,ih:()=>s,lP:()=>o});var n=r(8779);let a="corpepilates:seller";async function i(){try{return await n.kv.get(a)}catch{return null}}async function c(e){try{return await n.kv.set(a,e),!0}catch(e){return console.error("Error saving seller credentials:",e),!1}}async function o(e,t=5){try{let r=await i();if(!r)return!1;return r.feeEnabled=e,r.feePercentage=t,await n.kv.set(a,r),!0}catch{return!1}}async function s(){try{return await n.kv.del(a),!0}catch{return!1}}async function u(e){try{let t=await fetch("https://api.mercadopago.com/oauth/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",client_id:process.env.CLIENT_ID||"",client_secret:process.env.CLIENT_SECRET||"",refresh_token:e})});if(!t.ok)return null;let r=await t.json(),n={accessToken:r.access_token,refreshToken:r.refresh_token,userId:r.user_id.toString(),publicKey:r.public_key,expiresAt:Date.now()+1e3*r.expires_in,connectedAt:Date.now(),feeEnabled:!0,feePercentage:5};return await c(n),n}catch{return null}}async function p(){let e=await i();if(!e)return null;if(Date.now()>e.expiresAt-6e4){let t=await u(e.refreshToken);return t?.accessToken||null}return e.accessToken}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[276,779,59,994],()=>r(5730));module.exports=n})();